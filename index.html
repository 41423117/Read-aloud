<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古月方源 · 梟雄讀墨器</title>
    <style>
        body {
            font-family: "Noto Serif TC", "Microsoft JhengHei", serif;
            background-color: #1a1a1a; /* 深色背景符合方源氣質 */
            color: #d4d4d4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 90%;
            max-width: 850px;
            background: #252525;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #3d3d3d;
        }
        h2 { color: #a67c52; text-align: center; letter-spacing: 2px; }
        
        /* 文字顯示區域樣式 - 改為可高亮的 div */
        .text-display {
            width: 100%;
            height: 350px;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 19px;
            line-height: 1.8;
            box-sizing: border-box;
            background-color: #1e1e1e;
            color: #ccc;
            overflow-y: auto;
            white-space: pre-wrap;
            cursor: text;
        }
        
        /* 高亮當前朗讀句子的樣式 */
        .sentence {
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .current-sentence {
            background-color: #a67c52 !important;
            color: #1a1a1a !important;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }
        
        button, select, input[type="file"] {
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #a67c52;
            background: #2a2a2a;
            color: #a67c52;
            transition: 0.2s;
        }
        
        button:hover { background: #a67c52; color: #1a1a1a; }
        
        .status-info {
            margin-top: 15px;
            font-size: 13px;
            color: #777;
            text-align: center;
        }
        
        /* 文件上傳區域樣式 */
        .file-upload {
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* 語音篩選器樣式 */
        .voice-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .voice-filter label {
            font-size: 13px;
            color: #a67c52;
        }
        
        .voice-filter select {
            padding: 5px 10px;
            font-size: 13px;
            background: #2a2a2a;
            color: #a67c52;
            border: 1px solid #a67c52;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>梟雄朗讀器</h2>
    
    <div class="file-upload">
        <label>選取檔案：</label>
        <input type="file" id="fileInput" accept=".txt,.html,.js,.css,.json,.md">
    </div>

    <!-- 改為可高亮的 div 元素 -->
    <div id="textDisplay" class="text-display" contenteditable="true" placeholder="這世間，唯有利益永恆... 請放入你的文字。">這世間，唯有利益永恆... 請放入你的文字。</div>

    <div class="controls">
        <button id="playPauseBtn">開始 / 暫停 (Space)</button>
        <button id="prevBtn">上一句 (Home)</button>
        <button id="nextBtn">下一句 (End)</button>
        <button id="stopBtn">停止</button>
        
        <div>
            <label>語速：</label>
            <select id="rate">
                <option value="0.7">0.7x</option>
                <option value="0.8">0.8x</option>
                <option value="0.9">0.9x</option>
                <option value="1.0" selected>1.0x</option>
                <option value="1.1">1.1x</option>
                <option value="1.2">1.2x</option>
                <option value="1.5">1.5x</option>
                <option value="2.0">2.0x</option>
            </select>
        </div>

        <div>
            <label>聲線：</label>
            <select id="voiceSelect"></select>
        </div>
    </div>
    
    <!-- 語音篩選器 -->
    <div class="voice-filter">
        <label>篩選語音：</label>
        <select id="languageFilter">
            <option value="all">全部語音</option>
            <option value="zh">中文語音</option>
            <option value="en">英文語音</option>
            <option value="ja">日文語音</option>
            <option value="ko">韓文語音</option>
        </select>
    </div>

    <div class="status-info" id="status">只要利益足夠，萬物皆可利用。</div>
</div>

<script>
    const synth = window.speechSynthesis;
    const textDisplay = document.getElementById('textDisplay');
    const fileInput = document.getElementById('fileInput');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const voiceSelect = document.getElementById('voiceSelect');
    const languageFilter = document.getElementById('languageFilter');
    const statusDiv = document.getElementById('status');

    let sentences = [];
    let currentIdx = 0;
    let isPaused = false;
    let currentUtterance = null;
    let sentenceElements = [];
    let allVoices = [];
    let filteredVoices = [];

    // 初始化語音列表
    function populateVoiceList() {
        allVoices = synth.getVoices();
        
        // 根據篩選條件過濾語音
        const filter = languageFilter.value;
        filteredVoices = allVoices.filter(voice => {
            if (filter === 'all') return true;
            if (filter === 'zh') return voice.lang.includes('zh');
            if (filter === 'en') return voice.lang.includes('en');
            if (filter === 'ja') return voice.lang.includes('ja');
            if (filter === 'ko') return voice.lang.includes('ko');
            return true;
        });
        
        // 排序語音：中文優先，然後按語言代碼排序
        filteredVoices.sort((a, b) => {
            // 中文語音優先
            const aIsChinese = a.lang.includes('zh');
            const bIsChinese = b.lang.includes('zh');
            if (aIsChinese && !bIsChinese) return -1;
            if (!aIsChinese && bIsChinese) return 1;
            
            // 然後按語言代碼排序
            return a.lang.localeCompare(b.lang);
        });
        
        voiceSelect.innerHTML = '';
        
        filteredVoices.forEach((voice) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = voice.name;
            
            // 優先尋找 Microsoft Yunxi (雲希) 或 Yunjian (雲健) - 原版邏輯
            if (voice.name.includes('Yunxi') || voice.name.includes('Yunjian')) {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        });
        
        // 如果沒有選中任何語音，選擇第一個
        if (!voiceSelect.value && filteredVoices.length > 0) {
            voiceSelect.selectedIndex = 0;
        }
        
        statusDiv.innerText = `載入 ${filteredVoices.length} 個語音 (共 ${allVoices.length} 個)`;
    }

    populateVoiceList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
    }

    // 文件上傳處理
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            textDisplay.textContent = e.target.result;
            statusDiv.innerText = "文字已載入，準備收割。";
        };
        reader.readAsText(file);
    });

    // 語音篩選器事件
    languageFilter.addEventListener('change', populateVoiceList);

    // 將文本分割為句子並創建高亮元素
    function prepareTextForHighlighting() {
        const text = textDisplay.textContent.trim();
        if (!text) return [];
        
        // 清除之前的高亮
        sentenceElements.forEach(el => {
            if (el.classList) el.classList.remove('current-sentence');
        });
        
        // 分割句子（根據標點符號和換行）
        sentences = text.split(/[。！？；\n\r]+/).filter(s => s.trim().length > 0);
        
        // 如果沒有句子，返回空數組
        if (sentences.length === 0) return [];
        
        // 將文本替換為帶有高亮功能的句子
        textDisplay.innerHTML = '';
        sentenceElements = [];
        
        sentences.forEach((sentence, index) => {
            const span = document.createElement('span');
            span.className = 'sentence';
            span.textContent = sentence + (index < sentences.length - 1 ? '。' : '');
            span.dataset.index = index;
            textDisplay.appendChild(span);
            sentenceElements.push(span);
            
            // 添加換行（除了最後一句）
            if (index < sentences.length - 1) {
                textDisplay.appendChild(document.createElement('br'));
            }
        });
        
        return sentences;
    }

    // 高亮當前句子
    function highlightCurrentSentence() {
        // 清除所有高亮
        sentenceElements.forEach(el => {
            el.classList.remove('current-sentence');
        });
        
        // 高亮當前句子
        if (sentenceElements[currentIdx]) {
            sentenceElements[currentIdx].classList.add('current-sentence');
            
            // 滾動到可見區域
            sentenceElements[currentIdx].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }

    // 朗讀指定句子
    function speakSentence(index) {
        if (index < 0 || index >= sentences.length) {
            statusDiv.innerText = "朗讀結束。";
            isPaused = false;
            currentUtterance = null;
            return;
        }

        currentIdx = index;
        highlightCurrentSentence();
        
        // 停止當前的發音
        if (currentUtterance) {
            synth.cancel();
        }
        
        const utterance = new SpeechSynthesisUtterance(sentences[currentIdx]);
        currentUtterance = utterance;
        
        // 設置語速
        utterance.rate = parseFloat(document.getElementById('rate').value);
        
        // 方源聲線設定
        utterance.pitch = 0.85; // 調低音調，增加冷酷感
        
        // 獲取選中的語音
        const selectedVoiceName = voiceSelect.value;
        const selectedVoice = allVoices.find(v => v.name === selectedVoiceName) || filteredVoices[0];
        
        if (selectedVoice) {
            utterance.voice = selectedVoice;
        }
        
        utterance.onstart = () => {
            statusDiv.innerText = `朗讀中: ${currentIdx + 1}/${sentences.length}`;
            isPaused = false;
        };
        
        utterance.onend = () => {
            if (!isPaused && currentIdx < sentences.length - 1) {
                // 自動播放下一句
                currentIdx++;
                speakSentence(currentIdx);
            } else if (currentIdx >= sentences.length - 1) {
                statusDiv.innerText = "朗讀結束。";
                isPaused = false;
                currentUtterance = null;
            }
        };
        
        utterance.onerror = (event) => {
            console.error('SpeechSynthesisUtterance error:', event);
            statusDiv.innerText = "朗讀錯誤。";
            isPaused = false;
            currentUtterance = null;
        };
        
        synth.speak(utterance);
    }

    // 切換播放/暫停
    function togglePlay() {
        const text = textDisplay.textContent.trim();
        if (!text) {
            statusDiv.innerText = "請先輸入文字。";
            return;
        }
        
        if (sentences.length === 0) {
            prepareTextForHighlighting();
        }
        
        if (synth.speaking) {
            if (synth.paused) {
                // 繼續播放
                synth.resume();
                statusDiv.innerText = `繼續朗讀: ${currentIdx + 1}/${sentences.length}`;
                isPaused = false;
            } else {
                // 暫停播放
                synth.pause();
                statusDiv.innerText = "已暫停。";
                isPaused = true;
            }
        } else {
            // 開始新的朗讀
            if (sentences.length === 0) {
                sentences = prepareTextForHighlighting();
            }
            
            if (sentences.length === 0) {
                statusDiv.innerText = "沒有可朗讀的內容。";
                return;
            }
            
            // 如果已經在結尾，從頭開始
            if (currentIdx >= sentences.length) {
                currentIdx = 0;
            }
            
            isPaused = false;
            speakSentence(currentIdx);
        }
    }

    // 停止朗讀
    function stopSpeaking() {
        synth.cancel();
        isPaused = false;
        currentUtterance = null;
        
        // 清除高亮
        sentenceElements.forEach(el => {
            el.classList.remove('current-sentence');
        });
        
        statusDiv.innerText = "已停止。";
    }

    // 事件監聽
    playPauseBtn.addEventListener('click', togglePlay);
    
    document.getElementById('stopBtn').addEventListener('click', stopSpeaking);
    
    document.getElementById('prevBtn').addEventListener('click', () => {
        if (sentences.length === 0) return;
        
        synth.cancel();
        currentIdx = Math.max(0, currentIdx - 1);
        speakSentence(currentIdx);
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
        if (sentences.length === 0) return;
        
        synth.cancel();
        currentIdx = Math.min(sentences.length - 1, currentIdx + 1);
        speakSentence(currentIdx);
    });
    
    // 語速改變時更新當前發音
    document.getElementById('rate').addEventListener('change', () => {
        if (synth.speaking && !synth.paused && currentUtterance) {
            // 重新開始當前句子以應用新語速
            const tempIdx = currentIdx;
            synth.cancel();
            setTimeout(() => speakSentence(tempIdx), 100);
        }
    });
    
    // 語音改變時更新當前發音
    voiceSelect.addEventListener('change', () => {
        if (synth.speaking && !synth.paused && currentUtterance) {
            // 重新開始當前句子以應用新語音
            const tempIdx = currentIdx;
            synth.cancel();
            setTimeout(() => speakSentence(tempIdx), 100);
        }
    });

    // 鍵盤快捷鍵
    window.addEventListener('keydown', (e) => {
        // 防止在編輯文本時觸發快捷鍵
        if (e.target === textDisplay && e.code !== "Escape") return;
        
        if (e.code === "Space") {
            e.preventDefault();
            togglePlay();
        } else if (e.code === "Home") {
            e.preventDefault();
            document.getElementById('prevBtn').click();
        } else if (e.code === "End") {
            e.preventDefault();
            document.getElementById('nextBtn').click();
        } else if (e.code === "Escape") {
            e.preventDefault();
            stopSpeaking();
        }
    });
    
    // 初始化狀態
    statusDiv.innerText = "準備就緒。按下空格鍵開始朗讀。";
</script>

</body>
</html>
